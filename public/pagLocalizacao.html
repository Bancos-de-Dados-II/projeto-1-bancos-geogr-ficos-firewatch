<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FireWatch</title>
    <link rel="shortcut icon" href="/img/favicon_io/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="pagLocalizacao.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
</head>

<body>
    <div id="cabecario">
        <img id="imgCabecario" src="/img/cbmpb.png" alt="cbmpb">
    </div>
    <h1>Localização</h1>
    <div id="itens">
        <input type="text" id="cidade" placeholder="informe a cidade">
        <input type="text" id="rua" placeholder="informe uma rua ou lugar">
        <button id="searchButton">buscar</button>
    </div>

    <div id="map"></div>

    <div id="botao">

        <button id="enviar">Enviar</button>
    </div>




    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script>

        // Define o ícone personalizado
        var fireIcon = L.icon({
            iconUrl: '../img/fogo.png', // Caminho para a imagem
            iconSize: [32, 32],       // Tamanho do ícone
            iconAnchor: [16, 32],     // Posição do ponto do marcador no ícone
            popupAnchor: [0, -32]     // Localização do popup relativo ao ícone
        });

        // Declarar variáveis globais
        var map;
        var marker;
        let latitudeMarker, longitudemarker

        function success(pos) {
            const { latitude, longitude } = pos.coords;


            if (!map) {
                // Inicializa o mapa apenas uma vez
                map = L.map('map').setView([latitude, longitude], 17);

                // Adiciona o tile layer
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);

                // Cria o marcador inicial com o ícone personalizado
                marker = L.marker([latitude, longitude], { icon: fireIcon }).addTo(map)
                    .bindPopup('Você está aqui!')
                    .openPopup();

                map.on('click', e => {
                    marker.setLatLng(e.latlng);
                    latitudeMarker = e.latlng.lat; //pegando a localização do click
                    longitudemarker = e.latlng.lng;
                });

                document.getElementById('searchButton').addEventListener('click', () => { //buscar a localizção dos inputs no mapaa
                    console.log(longitudemarker, latitudeMarker)
                    let lugar = document.getElementById('cidade').value + " " + document.getElementById('rua').value
                    console.log(lugar)
                    fetch(`https://nominatim.openstreetmap.org/search?q=${lugar}&format=json`)
                        .then(response => response.json())
                        .then(data => {
                            let centro = [data[0].lat, data[0].lon];
                            map.panTo(centro);
                        })
                })


            } else {
                // Atualiza a posição do marcador
                marker.setLatLng([latitude, longitude]);
                map.setView([latitude, longitude], 17);
            }
        }

        function error(err) {
            console.error("Erro ao obter localização:", err);
        }

        // Rastreia a posição em tempo real
        navigator.geolocation.watchPosition(success, error, {
            enableHighAccuracy: true,
            timeout: 5000
        });
        
        //salva as informações dno local storage
        document.getElementById('enviar').addEventListener('click', () => {
            if (latitudeMarker && longitudemarker) {
                const coordenadas = {
                    latitude: latitudeMarker,
                    longitude: longitudemarker
                };
                localStorage.setItem('coordenadas', JSON.stringify(coordenadas));
                alert('Localização salva!');
                window.location.href = 'alertarIncendio.html';
            } else {
                alert('Por favor, selecione uma localização no mapa.');
            }
        });
    </script>
</body>

</html>